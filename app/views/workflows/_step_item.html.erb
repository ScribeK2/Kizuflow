<%#
  Step Item Partial
  
  Sprint 2: Action Step Simplification
  Collapsible step cards for better organization of long workflows.
  
  Local variables:
  - step: The step hash
  - index: The step index (0-based)
  - workflow: The workflow object
  - expanded: Whether the step should be expanded by default (optional, default: true)
%>

<% expanded = local_assigns.fetch(:expanded, true) %>
<% step_type = step['type']&.to_s&.downcase %>
<% step_id = step['id'] || SecureRandom.uuid %>

<%# Step type background colors (using hex for reliability) %>
<% type_bg_colors = {
  'question' => '#3b82f6',
  'decision' => '#a855f7',
  'simple_decision' => '#a855f7',
  'action' => '#22c55e',
  'checkpoint' => '#f97316'
} %>

<%# Step type icons %>
<% type_icons = {
  'question' => 'â“',
  'decision' => 'ðŸ”€',
  'simple_decision' => 'ðŸ”€',
  'action' => 'âš¡',
  'checkpoint' => 'ðŸ“'
} %>

<div class="step-item border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden bg-white dark:bg-gray-800/80 shadow-sm hover:shadow-md transition-shadow duration-200" 
     data-step-index="<%= index %>"
     data-controller="step-form collapsible-step"
     data-step-form-step-type-value="<%= step_type %>"
     data-step-form-step-index-value="<%= index %>"
     data-collapsible-step-expanded-value="<%= expanded %>"
     data-collapsible-step-step-type-value="<%= step_type %>">
  
  <%# Collapsible Header %>
  <div data-collapsible-step-target="header"
       class="flex items-center justify-between px-4 py-3 cursor-pointer select-none rounded-t-lg"
       style="background-color: <%= type_bg_colors[step_type] || '#6b7280' %>;"
       data-action="click->collapsible-step#toggle">
    
    <div class="flex items-center gap-3">
      <%# Drag Handle %>
      <span class="drag-handle cursor-move text-white/70 hover:text-white transition-colors" title="Drag to reorder">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
        </svg>
      </span>
      
      <%# Step Number & Type %>
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-white/20 text-white text-xs font-bold">
          <%= index + 1 %>
        </span>
        <span class="text-white/90 text-lg" title="<%= step_type&.titleize %>">
          <%= type_icons[step_type] || 'ðŸ“' %>
        </span>
      </div>
      
      <%# Step Title %>
      <span class="font-medium text-white truncate max-w-xs">
        <%= step['title'].presence || "Untitled #{step_type&.titleize}" %>
      </span>
      
      <%# Collapsed Summary (shown when collapsed) %>
      <span data-collapsible-step-target="stepSummary"
            class="hidden text-white/70 text-sm truncate max-w-md ml-2">
        <%# Summary will be generated by JavaScript %>
      </span>
    </div>
    
    <div class="flex items-center gap-2">
      <%# Remove Button %>
      <button type="button" 
              data-action="click->workflow-builder#removeStep"
              class="text-white/70 hover:text-white hover:bg-white/20 rounded p-1 transition-colors"
              title="Remove step"
              onclick="event.stopPropagation();">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
      </button>
      
      <%# Toggle Arrow %>
      <svg data-collapsible-step-target="toggleIcon"
           class="w-5 h-5 text-white/70 transition-transform duration-200"
           style="transform: rotate(180deg);"
           fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
      </svg>
    </div>
  </div>
  
  <%# Hidden Fields - Always submitted, OUTSIDE collapsible content to ensure they're always in the form %>
  <input type="hidden" name="workflow[steps][][id]" value="<%= step_id %>">
  <input type="hidden" name="workflow[steps][][index]" value="<%= index %>">
  <input type="hidden" name="workflow[steps][][type]" value="<%= step_type %>">
  <%# Hidden variable_name field for question steps - ensures it's always submitted even if step is collapsed %>
  <% if step_type == 'question' %>
    <input type="hidden" 
           name="workflow[steps][][variable_name]" 
           value="<%= step['variable_name'] %>"
           data-question-form-target="hiddenVariableName"
           id="variable_name_hidden_<%= step_id %>">
  <% end %>
  
  <%# Collapsible Content %>
  <div data-collapsible-step-target="content" class="p-4">
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4" 
         data-controller="preview-updater"
         data-preview-updater-url-value="<%= preview_workflow_path(workflow) %>"
         data-preview-updater-index-value="<%= index %>">
      
      <%# Form Fields Column %>
      <div class="space-y-4 min-w-0">
        <%# Title Field %>
        <div class="field-container">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">
            Step Title
          </label>
          <input type="text" 
                 name="workflow[steps][][title]" 
                 value="<%= step['title'] %>" 
                 placeholder="Enter a descriptive title..." 
                 class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                 required
                 data-step-form-target="field">
        </div>
        
        <%# Description Field %>
        <div class="field-container">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">
            Description
            <span class="font-normal text-gray-500 dark:text-gray-400">(optional)</span>
          </label>
          <textarea name="workflow[steps][][description]" 
                    placeholder="Add a brief description of this step..." 
                    class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-y" 
                    rows="2"
                    data-step-form-target="field"
                    data-variable-autocomplete-target="input"><%= step['description'] %></textarea>
        </div>
        
        <%# Type-Specific Fields %>
        <%= render partial: "step_fields", locals: { 
          step: step, 
          step_type: step_type, 
          available_steps: workflow.steps, 
          step_index: index, 
          workflow: workflow 
        } %>
      </div>
      
      <%# Preview Column %>
      <div class="min-w-0 lg:border-l lg:border-gray-200 lg:dark:border-gray-700 lg:pl-4">
        <div class="sticky top-4">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">
            Live Preview
          </label>
          <%= turbo_frame_tag "step_preview_#{index}", data: { preview_updater_target: "previewFrame" } do %>
            <%= render partial: "preview_pane", locals: { step: step, index: index } %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

