<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Header Section -->
  <div class="mb-8 flex justify-between items-center animate-fade-in">
    <div>
      <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-slate-800 dark:text-slate-100">
        Workflows
      </h1>
      <% if @selected_group.present? %>
        <!-- Breadcrumb -->
        <nav class="mt-2 flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400">
          <%= link_to "Workflows", workflows_path, class: "hover:text-gray-700 dark:hover:text-gray-300 transition-colors" %>
          <span>/</span>
          <% begin %>
            <% ancestors = @selected_group.ancestors rescue [] %>
            <% ancestors.reverse.each do |ancestor| %>
              <%= link_to ancestor.name, workflows_path(group_id: ancestor.id), class: "hover:text-gray-700 dark:hover:text-gray-300 transition-colors" %>
              <span>/</span>
            <% end %>
          <% rescue => e %>
            <% Rails.logger.error "Error rendering breadcrumb: #{e.message}" %>
          <% end %>
          <span class="text-gray-900 dark:text-gray-100 font-medium"><%= @selected_group.name %></span>
        </nav>
      <% end %>
    </div>
    <% if current_user&.can_create_workflows? %>
      <div class="flex space-x-3">
        <%= link_to import_workflows_path, class: "bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-3 rounded-full text-sm font-medium shadow-md hover:shadow-lg transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 inline-flex items-center" do %>
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
          </svg>
          Import
        <% end %>
        <%= link_to new_workflow_path, class: "bg-slate-600 hover:bg-slate-700 text-white px-6 py-3 rounded-full text-sm font-medium shadow-md hover:shadow-lg transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 inline-flex items-center" do %>
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          New Workflow
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Two-Column Layout: Sidebar + Main Content -->
  <div class="flex flex-col md:flex-row gap-6">
    <!-- Sidebar -->
    <div class="w-full md:w-64 flex-shrink-0">
      <%= render partial: "workflows/group_sidebar" %>
    </div>

    <!-- Main Content -->
    <div class="flex-1 min-w-0">
      <!-- Search Bar -->
      <div class="mb-6 animate-fade-in-up">
        <%= form_with url: workflows_path, method: :get, local: true, class: "solid-card overflow-hidden p-4", data: { controller: "workflow-search" } do |form| %>
          <%= hidden_field_tag :group_id, params[:group_id] if params[:group_id].present? %>
          <div class="flex items-center space-x-3">
            <div class="flex-1 relative">
              <div class="absolute top-1/2 left-0 pl-3 -translate-y-1/2 pointer-events-none z-10">
                <svg class="h-5 w-5 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <%= form.text_field :search,
                  value: @search_query,
                  placeholder: @selected_group ? "Search workflows in #{@selected_group.name}..." : "Search workflows by title or description...",
                  class: "block w-full pr-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-slate-500 dark:focus:ring-slate-400 focus:border-slate-500 dark:focus:border-slate-400 transition-colors",
                  style: "padding-left: 3rem;" %>
            </div>
            <% if @search_query.present? %>
              <%= link_to workflows_path(group_id: params[:group_id]), class: "px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-slate-100 dark:bg-slate-700 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition-all duration-200 hover:scale-105 inline-flex items-center" do %>
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Clear
              <% end %>
            <% end %>
            <%= form.submit "Search", class: "px-4 py-2 text-sm font-medium text-white bg-slate-600 hover:bg-slate-700 rounded-full shadow-md hover:shadow-lg transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800" %>
          </div>
        <% end %>
      </div>

      <!-- Workflows List -->
      <% if @workflows.any? %>
        <div class="solid-card overflow-hidden animate-fade-in-up">
          <ul class="divide-y divide-slate-200 dark:divide-slate-700">
            <%# Eager load associations to prevent N+1 queries %>
            <% @workflows.each_with_index do |workflow, index| %>
              <%= render partial: 'workflows/workflow_list_item', locals: { workflow: workflow, index: index } %>
            <% end %>
          </ul>
        </div>
      <% else %>
        <div class="solid-card p-12 text-center animate-fade-in-up">
          <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <h3 class="mt-4 text-lg font-medium text-gray-900 dark:text-gray-100">No workflows</h3>
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
            <% if @search_query.present? %>
              No workflows found matching "<%= @search_query %>"<% if @selected_group %> in <%= @selected_group.name %><% end %>.
            <% elsif @selected_group.present? %>
              No workflows in <%= @selected_group.name %>.
            <% else %>
              <%= current_user&.can_edit_workflows? ? "Get started by creating a new workflow." : "No public workflows available at the moment." %>
            <% end %>
          </p>
          <% if current_user&.can_create_workflows? %>
            <div class="mt-6">
              <%= link_to new_workflow_path, class: "inline-flex items-center px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-full text-sm font-medium shadow-md hover:shadow-lg transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800" do %>
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                New Workflow
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
