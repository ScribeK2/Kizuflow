<%# Action-specific fields partial %>
<%# This partial handles all fields for action steps, including file attachments %>

<div class="field-container"
     data-controller="instruction-template">

  <%# Instructions Field with Templates %>
  <div class="mb-4">
    <div class="flex items-center justify-between mb-2">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">
        Instructions <span class="text-red-500">*</span>
      </label>
      <%# Toggle button inline with label %>
      <button type="button"
              data-action="click->instruction-template#togglePanel"
              class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-emerald-700 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg hover:bg-emerald-100 dark:hover:bg-emerald-900/40 transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
        </svg>
        Insert Template
      </button>
    </div>

    <%# Template panel at full column width with z-index above Live Preview %>
    <%= render 'workflows/instruction_templates' %>

    <textarea name="workflow[steps][][instructions]"
              placeholder="Enter step-by-step instructions for the CSR to follow... (type {{ to insert variables)"
              class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-3 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm font-mono leading-relaxed resize-y"
              rows="5"
              data-step-form-target="field"
              data-instruction-template-target="instructionsField"
              data-variable-autocomplete-target="input"><%= step['instructions'] %></textarea>
  </div>

  <%# Attachments Section %>
  <div class="field-container" 
       data-controller="file-attachment"
       data-file-attachment-step-index-value="<%= defined?(step_index) ? step_index : '' %>">
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">
      Attachments
      <span class="font-normal text-gray-500 dark:text-gray-400">(optional)</span>
    </label>
    
    <%# Hidden input to store attachment signed IDs %>
    <input type="hidden" 
           name="workflow[steps][][attachments]" 
           value="<%= step['attachments'].present? ? step['attachments'].to_json : '[]' %>"
           data-file-attachment-target="attachmentsInput"
           data-step-form-target="field">
    
    <%# Drag and drop upload area %>
    <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center hover:border-blue-400 dark:hover:border-blue-500 transition-colors bg-gray-50 dark:bg-gray-800/50">
      <svg class="mx-auto h-10 w-10 text-gray-400 dark:text-gray-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
      </svg>
      
      <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">
        <label for="file-upload-<%= defined?(step_index) ? step_index : 'new' %>" 
               class="cursor-pointer text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 font-medium">
          Click to upload
        </label>
        or drag and drop
      </div>
      
      <input type="file" 
             id="file-upload-<%= defined?(step_index) ? step_index : 'new' %>"
             class="hidden"
             data-file-attachment-target="fileInput"
             data-action="change->file-attachment#handleFileSelect"
             multiple
             accept="image/*,.pdf,.doc,.docx,.txt,.csv">
      
      <p class="text-xs text-gray-500 dark:text-gray-500">
        Images, PDFs, Word docs, text files (max 10MB each)
      </p>
    </div>
    
    <%# Display existing attachments %>
    <div data-file-attachment-target="attachmentsList" class="mt-3 space-y-2">
      <% if step['attachments'].present? && step['attachments'].is_a?(Array) %>
        <% step['attachments'].each_with_index do |attachment_id, index| %>
          <% if attachment_id.present? %>
            <% begin %>
              <% blob = ActiveStorage::Blob.find_signed(attachment_id) %>
              <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700" data-attachment-id="<%= attachment_id %>">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                    <% if blob.content_type&.start_with?('image/') %>
                      <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                      </svg>
                    <% elsif blob.content_type == 'application/pdf' %>
                      <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                      </svg>
                    <% else %>
                      <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                      </svg>
                    <% end %>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-gray-900 dark:text-gray-100" data-file-name="<%= attachment_id %>"><%= blob.filename %></span>
                    <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">(<%= number_to_human_size(blob.byte_size) %>)</span>
                  </div>
                </div>
                <button type="button" 
                        class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 text-sm font-medium"
                        data-action="click->file-attachment#removeAttachment"
                        data-attachment-id="<%= attachment_id %>">
                  Remove
                </button>
              </div>
            <% rescue => e %>
              <div class="flex items-center justify-between p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800" data-attachment-id="<%= attachment_id %>">
                <div class="flex items-center gap-2">
                  <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                  </svg>
                  <span class="text-sm text-yellow-700 dark:text-yellow-300">Attachment not found</span>
                </div>
                <button type="button" 
                        class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 text-sm"
                        data-action="click->file-attachment#removeAttachment"
                        data-attachment-id="<%= attachment_id %>">
                  Remove
                </button>
              </div>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
