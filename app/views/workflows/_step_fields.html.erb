<% if step_type == "question" %>
  <%= render partial: "step_template_selector", locals: { step_type: step_type, step: step } %>
  <%= render partial: "question_fields", locals: { step: step } %>
<% elsif step_type == "decision" %>
  <%= render partial: "step_template_selector", locals: { step_type: step_type, step: step } %>
  <%= render partial: "decision_fields", locals: { step: step, available_steps: available_steps, workflow: defined?(workflow) ? workflow : nil } %>
<% elsif step_type == "action" %>
  <%= render partial: "step_template_selector", locals: { step_type: step_type, step: step } %>
  <%= render partial: "action_fields", locals: { step: step, step_index: defined?(index) ? index : nil } %>
<% elsif step_type.blank? %>
  <%# Fallback: if type is missing, show a message and try to infer from step data %>
  <div class="text-sm text-yellow-600 bg-yellow-50 border border-yellow-200 rounded p-2 mb-2">
    <p class="font-semibold">Step type missing</p>
    <p class="text-xs">This step appears to be incomplete. Please remove and re-add it.</p>
  </div>
  <%# Try to infer type from step data and render appropriate fields %>
  <% if step['question'].present? %>
    <%= render partial: "question_fields", locals: { step: step } %>
  <% elsif step['condition'].present? || step['branches'].present? %>
    <%= render partial: "decision_fields", locals: { step: step, available_steps: available_steps, workflow: defined?(workflow) ? workflow : nil } %>
  <% elsif step['action_type'].present? || step['instructions'].present? %>
    <%= render partial: "action_fields", locals: { step: step, step_index: defined?(index) ? index : nil } %>
  <% end %>
<% end %>

