<%# Selector for choosing a target workflow for sub-flow steps %>
<%# This partial is rendered within step forms when step type is sub_flow %>

<% step ||= {} %>
<% index ||= 0 %>

<div class="field-container"
     data-controller="subflow-selector"
     data-subflow-selector-current-workflow-id-value="<%= @workflow&.id %>">
  <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">
    Target Workflow
    <span class="text-red-500">*</span>
  </label>

  <input type="hidden"
         name="workflow[steps][][target_workflow_id]"
         value="<%= step['target_workflow_id'] %>"
         data-subflow-selector-target="hiddenInput">

  <select data-subflow-selector-target="select"
          data-action="change->subflow-selector#selectWorkflow"
          class="w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm py-2 px-3 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 focus:border-indigo-500 dark:focus:border-indigo-400">
    <option value="">-- Select a workflow --</option>
    <%# Options will be populated dynamically by the controller %>
  </select>

  <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
    Select a published workflow to execute as a sub-routine.
    The child workflow will inherit variables from the parent and return its results.
  </p>
</div>

<% if step['target_workflow_id'].present? %>
  <% target_workflow = Workflow.find_by(id: step['target_workflow_id']) %>
  <% if target_workflow %>
    <div class="mt-3 p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg border border-indigo-200 dark:border-indigo-800/30">
      <div class="flex items-center justify-between">
        <div>
          <h4 class="text-sm font-medium text-indigo-800 dark:text-indigo-200">
            <%= target_workflow.title %>
          </h4>
          <p class="text-xs text-indigo-600 dark:text-indigo-300 mt-0.5">
            <%= target_workflow.steps&.length || 0 %> steps
            <% if target_workflow.graph_mode? %>
              <span class="ml-1 px-1.5 py-0.5 bg-indigo-200 dark:bg-indigo-800 rounded text-xs">Graph</span>
            <% end %>
          </p>
        </div>
        <%= link_to workflow_path(target_workflow), target: "_blank", class: "text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 text-sm" do %>
          View
          <svg class="inline w-3 h-3 ml-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
          </svg>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="mt-3 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800/30">
      <p class="text-sm text-red-700 dark:text-red-300">
        Target workflow #<%= step['target_workflow_id'] %> not found. Please select a valid workflow.
      </p>
    </div>
  <% end %>
<% end %>

<div class="field-container mt-4">
  <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">
    Variable Mapping
    <span class="text-xs text-gray-500 dark:text-gray-400 font-normal">(optional)</span>
  </label>

  <div class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-3 border border-gray-200 dark:border-gray-700">
    <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">
      By default, all parent workflow variables are passed to the sub-flow.
      Child workflow results are merged back to the parent upon completion.
    </p>

    <input type="hidden"
           name="workflow[steps][][variable_mapping]"
           value="<%= (step['variable_mapping'] || {}).to_json %>">

    <div class="text-xs text-gray-400 dark:text-gray-500 italic">
      Advanced variable mapping editor coming soon.
    </div>
  </div>
</div>
