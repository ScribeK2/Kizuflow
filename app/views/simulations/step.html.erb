<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="mb-8 animate-fade-in">
    <% if current_user&.user? %>
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-gray-100 tracking-tight break-words" title="<%= @workflow.title %>">
        <%= truncate(@workflow.title, length: 60, omission: '...') %>
      </h1>
      <p class="mt-2 text-gray-600 dark:text-gray-400">Step-by-step execution</p>
    <% else %>
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-gray-100 tracking-tight">Running Simulation</h1>
      <p class="mt-2 text-gray-600 dark:text-gray-400">Step-by-step execution of <%= @workflow.title %></p>
    <% end %>
  </div>

  <% if @simulation.execution_path.present? && @simulation.execution_path.any? %>
    <div class="solid-card overflow-hidden mb-6 animate-fade-in-up">
      <div class="px-6 py-5 border-b border-slate-200 dark:border-slate-700">
        <h2 class="text-sm font-bold text-gray-900 dark:text-gray-100">Progress</h2>
      </div>
      <div class="p-6 w-full overflow-hidden">
        <div class="overflow-x-auto overflow-y-hidden progress-scroll" style="width: 100%; max-width: 100%; box-sizing: border-box;">
          <div class="flex items-center gap-2 pb-2" style="display: flex; width: max-content;">
            <% @simulation.execution_path.each_with_index do |path_item, index| %>
              <div class="flex items-center flex-shrink-0" style="flex-shrink: 0;">
                <% 
                  # Determine if this is the current step
                  is_current = index == @simulation.execution_path.length - 1 && !@simulation.complete?
                  is_completed = index < @simulation.execution_path.length - 1 || @simulation.complete?
                %>
                <button type="button" 
                        onclick="location.href='<%= step_simulation_path(@simulation) %>?step=<%= index %>'"
                        class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all duration-200 whitespace-nowrap <%= is_current ? 'bg-slate-600 text-white shadow-md ring-2 ring-slate-300 dark:ring-slate-500' : is_completed ? 'bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700' : 'bg-gray-100 dark:bg-gray-800/50 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-800/80' %> cursor-pointer"
                        style="flex-shrink: 0;">
                  <span class="font-semibold"><%= index + 1 %></span>
                  <span class="ml-2 hidden sm:inline"><%= truncate(path_item['step_title'], length: 20) %></span>
                  <% if path_item['answer'].present? && is_completed %>
                    <span class="ml-1 text-xs opacity-75 hidden md:inline">(<%= truncate(path_item['answer'].to_s, length: 10) %>)</span>
                  <% end %>
                </button>
                <% unless index == @simulation.execution_path.length - 1 %>
                  <svg class="w-4 h-4 text-gray-400 dark:text-gray-500 mx-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                <% end %>
              </div>
            <% end %>
            <% unless @simulation.complete? %>
              <div class="flex items-center flex-shrink-0 ml-2" style="flex-shrink: 0;">
                <div class="w-8 h-8 rounded-full border-2 border-dashed border-gray-300 dark:border-gray-600 flex items-center justify-center flex-shrink-0" style="flex-shrink: 0;">
                  <span class="text-xs font-semibold text-gray-400 dark:text-gray-500"><%= @simulation.current_step_index + 1 %></span>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <% if @simulation.complete? %>
    <div class="solid-card overflow-hidden text-center animate-fade-in-up">
      <div class="p-8">
        <h2 class="text-2xl font-bold text-green-600 dark:text-green-400 mb-2">Simulation Complete!</h2>
        <p class="text-green-700 dark:text-green-300 mb-4">All steps have been completed.</p>
        <%= link_to "View Results", simulation_path(@simulation), class: "bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105" %>
      </div>
    </div>
  <% else %>
    <% step = @simulation.current_step %>
    <% if step %>
      <div class="solid-card overflow-hidden mb-6 animate-fade-in-up">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
              <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-slate-600 text-white text-lg font-semibold mr-4">
                <%= @simulation.current_step_index + 1 %>
              </span>
              <div>
                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100"><%= VariableInterpolator.interpolate(step['title'], @simulation.results || {}) %></h2>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 mt-1">
                  <%= step['type'] %>
                </span>
              </div>
            </div>
            <%= form_with url: stop_simulation_path(@simulation), method: :post, local: true, data: { turbo_confirm: "Are you sure you want to stop this workflow? You can't continue after stopping." } do |form| %>
              <%= form.submit "Stop Workflow", class: "px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800" %>
            <% end %>
          </div>

          <% if step['description'].present? %>
            <div class="text-gray-600 dark:text-gray-300 mb-4"><%= render_step_markdown(VariableInterpolator.interpolate(step['description'], @simulation.results || {})) %></div>
          <% end %>

          <% case step['type'] %>
          <% when 'question' %>
            <%= form_with url: next_step_simulation_path(@simulation), method: :post, local: true, class: "space-y-4" do |form| %>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  <%= VariableInterpolator.interpolate(step['question'] || step['title'], @simulation.results || {}) %>
                </label>
                
                <% if step['answer_type'] == 'yes_no' %>
                  <div class="space-y-2">
                    <div class="flex items-center">
                      <%= form.radio_button :answer, "yes", { class: "mr-2", required: true } %>
                      <%= form.label :answer_yes, "Yes", class: "text-gray-700 dark:text-gray-300" %>
                    </div>
                    <div class="flex items-center">
                      <%= form.radio_button :answer, "no", { class: "mr-2", required: true } %>
                      <%= form.label :answer_no, "No", class: "text-gray-700 dark:text-gray-300" %>
                    </div>
                  </div>
                <% elsif step['answer_type'] == 'multiple_choice' %>
                  <% if step['options'].present? %>
                    <div class="space-y-2">
                      <% step['options'].each do |option| %>
                        <div class="flex items-center">
                          <%= form.radio_button :answer, option['value'] || option['label'], { class: "mr-2", required: true } %>
                          <%= form.label :answer, option['label'] || option['value'], class: "text-gray-700 dark:text-gray-300" %>
                        </div>
                      <% end %>
                    </div>
                  <% else %>
                    <%= form.text_field :answer, { class: "w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm py-2 px-3 bg-white/50 dark:bg-gray-800/50 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-slate-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400", required: true } %>
                  <% end %>
                <% elsif step['answer_type'] == 'dropdown' %>
                  <% if step['options'].present? %>
                    <%= form.select :answer, step['options'].map { |opt| [opt['label'] || opt['value'], opt['value'] || opt['label']] }, { prompt: "-- Select --" }, { class: "w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm py-2 px-3 bg-white/50 dark:bg-gray-800/50 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-slate-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400", required: true } %>
                  <% else %>
                    <%= form.text_field :answer, { class: "w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm py-2 px-3 bg-white/50 dark:bg-gray-800/50 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-slate-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400", required: true } %>
                  <% end %>
                <% else %>
                  <%= form.text_field :answer, { class: "w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm py-2 px-3 bg-white/50 dark:bg-gray-800/50 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-slate-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400", required: true, placeholder: step['answer_type'] == 'number' ? 'Enter a number' : step['answer_type'] == 'date' ? 'YYYY-MM-DD' : '' } %>
                <% end %>
              </div>
              
              <div class="flex justify-end space-x-3 pt-4">
                <%= link_to "Cancel", workflow_path(@workflow), class: "bg-white/50 dark:bg-gray-800/50 py-2 px-4 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-white/80 dark:hover:bg-gray-800/80 transition-all duration-200 hover:scale-105" %>
                <%= form.submit "Continue", class: "bg-slate-600 hover:bg-slate-700 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105" %>
              </div>
            <% end %>
            
          <% when 'action' %>
            <div class="backdrop-blur-sm bg-blue-50/50 dark:bg-blue-900/20 border border-blue-200/30 dark:border-blue-800/30 rounded-lg p-4 mb-4">
              <h3 class="text-sm font-semibold text-blue-900 dark:text-blue-200 mb-2">Instructions:</h3>
              <div class="text-sm text-blue-800 dark:text-blue-300"><%= render_step_markdown(VariableInterpolator.interpolate(step['instructions'], @simulation.results || {})) %></div>
            </div>
            
            <%= form_with url: next_step_simulation_path(@simulation), method: :post, local: true do |form| %>
              <%= form.hidden_field :answer, value: "" %>
              <div class="flex justify-end space-x-3 pt-4">
                <%= link_to "Cancel", workflow_path(@workflow), class: "bg-white/50 dark:bg-gray-800/50 py-2 px-4 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-white/80 dark:hover:bg-gray-800/80 transition-all duration-200 hover:scale-105" %>
                <%= form.submit "Continue", class: "bg-slate-600 hover:bg-slate-700 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105" %>
              </div>
            <% end %>
            
          <% when 'decision', 'simple_decision' %>
            <%# Decision steps are auto-processed and should not be displayed %>
            <%# This case should never be reached due to auto-advance in controller %>
            <div class="backdrop-blur-sm bg-purple-50/50 dark:bg-purple-900/20 border border-purple-200/30 dark:border-purple-800/30 rounded-lg p-4 mb-4">
              <p class="text-sm text-purple-800 dark:text-purple-300">Processing routing decision...</p>
              <p class="text-xs text-purple-600 dark:text-purple-400 mt-2">If you see this message, please refresh the page.</p>
            </div>
            <%= form_with url: next_step_simulation_path(@simulation), method: :post, local: true do |form| %>
              <%= form.hidden_field :answer, value: "" %>
              <div class="flex justify-end pt-4">
                <%= form.submit "Continue", class: "bg-slate-600 hover:bg-slate-700 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105" %>
              </div>
            <% end %>
            
          <% when 'checkpoint' %>
            <div class="backdrop-blur-sm bg-green-50/50 dark:bg-green-900/20 border border-green-200/30 dark:border-green-800/30 rounded-lg p-4 mb-4">
              <div class="flex items-start">
                <svg class="w-6 h-6 text-green-600 dark:text-green-400 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div class="flex-1">
                  <h3 class="text-sm font-semibold text-green-900 dark:text-green-200 mb-2">Checkpoint</h3>
                  <div class="text-sm text-green-800 dark:text-green-300">
                    <% if step['description'].present? %>
                      <%= render_step_markdown(step['description']) %>
                    <% else %>
                      Is the issue resolved? You can mark it as resolved to complete the workflow early, or continue to the next step.
                    <% end %>
                  </div>
                </div>
              </div>
            </div>

            <%= form_with url: resolve_checkpoint_simulation_path(@simulation), method: :post, local: true, class: "space-y-4" do |form| %>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                  Optional notes:
                </label>
                <%= form.text_area :notes, { rows: 3, class: "w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm py-2 px-3 bg-white/50 dark:bg-gray-800/50 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-slate-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400", placeholder: "Add any notes about the resolution..." } %>
              </div>

              <div class="flex justify-end space-x-3 pt-4">
                <%= form.hidden_field :resolved, value: "false" %>
                <%= form.submit "Continue Workflow", name: "resolved", value: "false", class: "bg-white/50 dark:bg-gray-800/50 py-2 px-4 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-white/80 dark:hover:bg-gray-800/80 transition-all duration-200 hover:scale-105" %>
                <%= form.submit "Issue Resolved", name: "resolved", value: "true", class: "bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105" %>
              </div>
            <% end %>

          <% when 'message' %>
            <div class="backdrop-blur-sm bg-cyan-50/50 dark:bg-cyan-900/20 border border-cyan-200/30 dark:border-cyan-800/30 rounded-lg p-4 mb-4">
              <div class="flex items-start">
                <svg class="w-6 h-6 text-cyan-600 dark:text-cyan-400 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div class="flex-1">
                  <% if step['content'].present? %>
                    <div class="text-sm text-cyan-800 dark:text-cyan-300"><%= render_step_markdown(VariableInterpolator.interpolate(step['content'], @simulation.results || {})) %></div>
                  <% else %>
                    <p class="text-sm text-cyan-800 dark:text-cyan-300 italic">No message content provided.</p>
                  <% end %>
                </div>
              </div>
            </div>

            <%= form_with url: next_step_simulation_path(@simulation), method: :post, local: true do |form| %>
              <%= form.hidden_field :answer, value: "" %>
              <div class="flex justify-end space-x-3 pt-4">
                <%= link_to "Cancel", workflow_path(@workflow), class: "bg-white/50 dark:bg-gray-800/50 py-2 px-4 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-white/80 dark:hover:bg-gray-800/80 transition-all duration-200 hover:scale-105" %>
                <%= form.submit "Continue", class: "bg-slate-600 hover:bg-slate-700 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105" %>
              </div>
            <% end %>

          <% when 'escalate' %>
            <div class="backdrop-blur-sm bg-orange-50/50 dark:bg-orange-900/20 border border-orange-200/30 dark:border-orange-800/30 rounded-lg p-4 mb-4">
              <div class="flex items-start">
                <svg class="w-6 h-6 text-orange-600 dark:text-orange-400 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12" />
                </svg>
                <div class="flex-1">
                  <h3 class="text-sm font-semibold text-orange-900 dark:text-orange-200 mb-2">Escalation Required</h3>
                  <% if step['target_type'].present? || step['target_value'].present? %>
                    <p class="text-sm text-orange-800 dark:text-orange-300 mb-2">
                      <strong>Target:</strong>
                      <%= step['target_type']&.titleize %><%= " - #{step['target_value']}" if step['target_value'].present? %>
                    </p>
                  <% end %>
                  <% if step['priority'].present? && step['priority'] != 'normal' %>
                    <p class="text-sm text-orange-800 dark:text-orange-300 mb-2">
                      <strong>Priority:</strong>
                      <span class="<%= step['priority'] == 'urgent' ? 'text-red-600 dark:text-red-400 font-semibold' : step['priority'] == 'high' ? 'text-orange-600 dark:text-orange-400 font-medium' : '' %>">
                        <%= step['priority']&.titleize %>
                      </span>
                    </p>
                  <% end %>
                  <% if step['notes'].present? %>
                    <div class="text-sm text-orange-700 dark:text-orange-300 mt-2"><%= render_step_markdown(VariableInterpolator.interpolate(step['notes'], @simulation.results || {})) %></div>
                  <% end %>
                </div>
              </div>
            </div>

            <%= form_with url: next_step_simulation_path(@simulation), method: :post, local: true do |form| %>
              <%= form.hidden_field :answer, value: "" %>
              <div class="flex justify-end space-x-3 pt-4">
                <%= link_to "Cancel", workflow_path(@workflow), class: "bg-white/50 dark:bg-gray-800/50 py-2 px-4 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-white/80 dark:hover:bg-gray-800/80 transition-all duration-200 hover:scale-105" %>
                <%= form.submit "Continue", class: "bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105" %>
              </div>
            <% end %>

          <% when 'resolve' %>
            <div class="backdrop-blur-sm bg-emerald-50/50 dark:bg-emerald-900/20 border border-emerald-200/30 dark:border-emerald-800/30 rounded-lg p-4 mb-4">
              <div class="flex items-start">
                <svg class="w-6 h-6 text-emerald-600 dark:text-emerald-400 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div class="flex-1">
                  <h3 class="text-sm font-semibold text-emerald-900 dark:text-emerald-200 mb-2">Resolution</h3>
                  <% if step['resolution_type'].present? %>
                    <p class="text-sm text-emerald-800 dark:text-emerald-300 mb-2">
                      <strong>Type:</strong>
                      <span class="<%= step['resolution_type'] == 'success' ? 'text-green-600 dark:text-green-400' : step['resolution_type'] == 'failure' ? 'text-red-600 dark:text-red-400' : '' %>">
                        <%= step['resolution_type']&.titleize %>
                      </span>
                    </p>
                  <% end %>
                  <% if step['resolution_code'].present? %>
                    <p class="text-sm text-emerald-800 dark:text-emerald-300 mb-2">
                      <strong>Code:</strong> <%= step['resolution_code'] %>
                    </p>
                  <% end %>
                </div>
              </div>
            </div>

            <%= form_with url: next_step_simulation_path(@simulation), method: :post, local: true do |form| %>
              <%= form.hidden_field :answer, value: "" %>
              <div class="flex justify-end space-x-3 pt-4">
                <%= link_to "Cancel", workflow_path(@workflow), class: "bg-white/50 dark:bg-gray-800/50 py-2 px-4 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-white/80 dark:hover:bg-gray-800/80 transition-all duration-200 hover:scale-105" %>
                <%= form.submit "Complete Workflow", class: "bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105" %>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    <% else %>
      <div class="solid-card overflow-hidden">
        <div class="p-6">
          <p class="text-red-600 dark:text-red-400">Error: Could not load current step.</p>
        </div>
      </div>
    <% end %>
  <% end %>

  <div class="mt-6">
    <%= link_to "Back to Workflow", workflow_path(@workflow), class: "text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 text-sm font-medium transition-colors duration-200" %>
  </div>
</div>

